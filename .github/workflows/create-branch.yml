# WARNING: DO NOT EDIT!
#
# This file was generated by plugin_template, and is managed by it. Please use
# './plugin-template --github galaxy_ng' to update this file.
#
# For more info visit https://github.com/pulp/plugin_template

---
name: Create New Release Branch
on:
  workflow_dispatch:

env:
  RELEASE_WORKFLOW: true

jobs:
  create-branch:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: galaxy_ng

      - uses: actions/setup-python@v4
        with:
          python-version: "3.8"

      - name: Install python dependencies
        run: |
          echo ::group::PYDEPS
          pip install bump2version jinja2 pyyaml
          echo ::endgroup::

      - name: Setting secrets
        working-directory: galaxy_ng
        run: python3 .github/workflows/scripts/secrets.py "$SECRETS_CONTEXT"
        env:
          SECRETS_CONTEXT: ${{ toJson(secrets) }}

      - name: Determine new branch name
        working-directory: galaxy_ng
        run: |
          # Just to be sure...
          git checkout master
          NEW_BRANCH="$(bump2version --dry-run --list release | sed -Ene 's/^new_version=([[:digit:]]+\.[[:digit:]]+)\..*$/\1/p')"
          if [ -z "$NEW_BRANCH" ]
          then
            echo Could not determine the new branch name.
            exit 1
          fi
          echo "NEW_BRANCH=${NEW_BRANCH}" >> "$GITHUB_ENV"

      - name: Create release branch
        working-directory: galaxy_ng
        run: |
          git branch "${NEW_BRANCH}"

      - name: Bump version on master branch
        working-directory: galaxy_ng
        run: |
          bump2version --no-commit minor

      - name: Remove entries from CHANGES directory
        working-directory: galaxy_ng
        run: |
          find CHANGES -type f -regex ".*\.\(bugfix\|doc\|feature\|misc\|deprecation\|removal\)" -exec git rm {} +

      - name: Make a PR with version bump and without CHANGES/*
        uses: peter-evans/create-pull-request@v4
        with:
          path: galaxy_ng
          token: ${{ secrets.RELEASE_TOKEN }}
          committer: ansible <ansible-infra@redhat.com>
          author: ansible <ansible-infra@redhat.com>
          branch: minor-version-bump
          base: master
          title: Bump minor version
          body: '[noissue]'
          commit-message: |
            Bump minor version
            [noissue]
          delete-branch: true

      - name: Push release branch
        working-directory: galaxy_ng
        run: |
          git push origin "${NEW_BRANCH}"
